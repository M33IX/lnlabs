#!/bin/bash

# Инициализация переменных
cr=0          # Флаг создания файла с контрольными суммами
fileName=""  # Имя файла с контрольными суммами
dirName=""   # Имя каталога, для которого выполняется проверка

# Парсинг аргументов командной строки
while getopts cd:f: arg
do
    case "$arg" in
        c) # Если установлен флаг 'c', устанавливаем cr в 1
            cr=1;;
        d) # Задаем имя каталога
            dirName="$OPTARG";;
        f) # Задаем имя файла с контрольными суммами
            fileName="$OPTARG";;
        *) # Если передан неизвестный аргумент, выводим сообщение об ошибке
            echo "err";;
    esac
done

# Получение списка файлов в каталоге
array=()
while IFS= read -r -d $'\0'; do
    if [[ -f "$REPLY" ]] # Проверяем, является ли элемент файлом
    then
        array+=("$REPLY") # Добавляем файл в массив
    fi
done < <(find "$dirName" -print0) # Используем 'find' для получения списка файлов в каталоге, разделенных нулевым символом

# Проверка целостности файлов или создание файла с контрольными суммами
i=0
size=${#array[*]}
if [ "$cr" -eq 1 ] # Если установлен флаг 'c'
then
    while [ "$size" -gt "$i" ] # Пока не пройдем по всем файлам в массиве
    do
        md5=`md5sum ${array[i]}` # Вычисляем контрольную сумму для файла
        echo "$md5" >> "$fileName" # Записываем контрольную сумму в файл
        ((++i)) # Увеличиваем индекс
    done
else
    while [ "$size" -gt "$i" ] # Пока не пройдем по всем файлам в массиве
    do
        IFS=$'\n'
        tmp=0
        for a in $(cat "$fileName") # Итерируемся по строкам файла с контрольными суммами
        do
            IFS=' '
            md=()
            read -a md <<< "$a" # Разбиваем строку на массив по пробелам
            if [ ${array[i]} == ${md[1]} ] # Если имена файлов совпадают
            then
                md5=`md5sum ${array[i]}` # Вычисляем контрольную сумму для текущего файла
                if [ "$md5" == "$a" ] # Если контрольные суммы совпадают
                then
                    echo ${array[i]} OK # Файл не изменился
                    tmp=1
                    break
                else
                    echo ${array[i]} changed # Файл был изменен
                    tmp=1
                    break
                fi
            fi
        done
        if [ "$tmp" -eq 0 ] # Если файл не найден в файле с контрольными суммами
        then
            echo ${array[i]} is a new file # Файл является новым
        fi
        ((i++)) # Увеличиваем индекс
    done
    # Проверяем удаленные файлы
    while IFS= read -r -d $'\0'; do
        if [[ ! -f "$REPLY" ]]; then # Если файл больше не существует
            echo "$REPLY was deleted" # Выводим сообщение об удаленном файле
        fi
    done < <(find "$dirName" -type f -print0) # Ищем файлы в каталоге
fi

unset IFS # Восстанавливаем переменную IFS
