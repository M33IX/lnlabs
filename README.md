#!/bin/bash

# Инициализация переменных
cr=0         # Флаг создания файла с контрольными суммами
fileName=""  # Имя файла с контрольными суммами
dirName=""   # Имя каталога, для которого выполняется проверка

# Парсинг аргументов командной строки
while getopts cd:f: arg
do
    case "$arg" in
        c) # Если установлен флаг 'c', устанавливаем cr в 1
            cr=1;;
        d) # Задаем имя каталога
            dirName="$OPTARG";;
        f) # Задаем имя файла с контрольными суммами
            fileName="$OPTARG";;
        *) # Если передан неизвестный аргумент, выводим сообщение об ошибке
            echo "err";;
    esac
done

# Получение списка файлов в каталоге
array=()
while IFS= read -r -d $'\0'; do
    if [[ -f "$REPLY" ]]; then # Проверяем, является ли элемент файлом
        array+=("$REPLY") # Добавляем файл в массив
    fi
done < <(find "$dirName" -print0) # Используем 'find' для получения списка файлов в каталоге, разделенных нулевым символом

# Проверка целостности файлов или создание файла с контрольными суммами
if [ "$cr" -eq 1 ]; then # Если установлен флаг 'c'
    for file in "${array[@]}"; do
        md5sum "$file" >> "$fileName" # Записываем контрольную сумму в файл
    done
else
    while IFS= read -r line; do
        file="${line#* }" # Получаем имя файла из строки контрольной суммы
        if [ -e "$file" ]; then # Проверяем существует ли файл
            md5=$(md5sum "$file") # Вычисляем текущую контрольную сумму
            if [ "$md5" == "$line" ]; then # Сравниваем суммы
                echo "$file OK" # Файл не изменен
            else
                echo "$file changed" # Файл был изменен
            fi
        else
            echo "$file was deleted" # Файл был удален
        fi
    done < "$fileName"
fi

unset IFS # Восстанавливаем переменную IFS
